# Shared Taskfile for Python projects using uv
# Required variables: USER_NAME, ARTIFACT_NAME, COMMANDS (array of command names)

version: '3'

includes:
  helpers:
    taskfile: https://github.com/paigemae/taskfiles/raw/main/Taskfile.helpers.yaml
    internal: true

tasks:
  init:
    desc: "Initialize Python project with uv and install dependencies"
    cmds:
      - uv venv
      - uv pip install -e .
      - uv pip install -e ".[dev]"

  clean:
    desc: "Clean up generated files, cache, and build artifacts"
    cmds:
      - task: helpers::delete-paths
        vars:
          PATHS: ".venv dist build .pytest_cache .coverage htmlcov"
      - task: helpers::delete-pattern
        vars:
          PATTERN: "__pycache__"
          TYPE: "d"
      - task: helpers::delete-pattern
        vars:
          PATTERN: "*.pyc"
          TYPE: "f"
      - task: helpers::delete-pattern
        vars:
          PATTERN: "*.pyo"
          TYPE: "f"
      - task: helpers::delete-pattern
        vars:
          PATTERN: "*.egg-info"
          TYPE: "d"

  install:
    desc: "Install dependencies using uv"
    cmds:
      - uv pip install -e ".[dev]"

  sync:
    desc: "Sync dependencies from requirements files"
    cmds:
      - uv pip sync requirements.txt || uv pip install -r requirements.txt

  run:
    desc: "Run a specific command (usage: task python:run CMD=main)"
    cmds:
      - uv run python -m {{.CMD | default .ARTIFACT_NAME}}

  test:
    desc: "Run Python tests with pytest"
    cmds:
      - uv run pytest -v

  test-with-cover:
    desc: "Run Python tests with coverage HTML report"
    cmds:
      - uv run pytest --cov --cov-report=html --cov-report=term -v
      - task: helpers::open-file
        vars:
          FILE: "htmlcov/index.html"

  ci-test:
    desc: "Run tests with coverage for CI"
    cmds:
      - uv run pytest --cov --cov-report=xml --cov-report=term -v

  fmt:
    desc: "Format Python code with ruff"
    cmds:
      - uv run ruff format .

  lint:
    desc: "Lint Python code with ruff"
    cmds:
      - uv run ruff check .

  lint-fix:
    desc: "Lint and auto-fix Python code with ruff"
    cmds:
      - uv run ruff check --fix .

  check:
    desc: "Run formatting and linting checks"
    deps:
      - fmt
      - lint

  type-check:
    desc: "Run type checking with mypy"
    cmds:
      - uv run mypy .

  verify:
    desc: "Run all checks (format, lint, type-check, test)"
    deps:
      - fmt
      - lint
      - type-check
      - test

  build:
    desc: "Build Python package distribution"
    cmds:
      - uv build

  publish:
    desc: "Publish package to PyPI (use with caution)"
    cmds:
      - uv publish

  lock:
    desc: "Generate requirements lock file"
    cmds:
      - uv pip compile pyproject.toml -o requirements.txt

  upgrade:
    desc: "Upgrade all dependencies"
    cmds:
      - uv pip install --upgrade -e ".[dev]"
